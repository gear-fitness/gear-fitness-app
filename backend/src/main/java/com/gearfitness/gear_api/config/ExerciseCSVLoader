package com.gearfitness.gear_api.config;

import com.gearfitness.gear_api.entity.Exercise;
import com.gearfitness.gear_api.repository.ExerciseRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.io.BufferedReader;
import java.io.InputStreamReader;

@Component
@RequiredArgsConstructor
public class ExerciseCSVLoader implements CommandLineRunner {
    private final ExerciseRepository exerciseRepository;

    @Override
    public void run(String... args) throws Exception {
        var inputStream = getClass()
                .getClassLoader()
                .getResourceAsStream("exercises_seed.csv");

        if (inputStream == null) {
            throw new RuntimeException("CSV file not found");
        }

        int inserted = 0;
        int skipped = 0;

        try (BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))) {
            String line;
            boolean firstLine = true;

            while ((line = reader.readLine()) != null) {
                if (firstLine) {
                    firstLine = false;
                    continue; // skip header
                }

                // Limit = 3 so commas inside description are preserved
                String[] cols = line.split(",", 3);

                if (cols.length < 3) {
                    skipped++;
                    continue;
                }

                String name = cols[0].trim();
                String bodyPartRaw = cols[1].trim();
                String description = cleanDescription(cols[2]);

                // Skip duplicates (case-insensitive)
                if (exerciseRepository.findByNameIgnoreCase(name).isPresent()) {
                    skipped++;
                    continue;
                }

                Exercise exercise = Exercise.builder()
                        .name(name)
                        .bodyPart(Exercise.BodyPart.valueOf(bodyPartRaw.toUpperCase()))
                        .description(description)
                        .build();

                exerciseRepository.save(exercise);
                inserted++;
            }
        }

        System.out.println("Exercise CSV seed complete.");
        System.out.println("Inserted: " + inserted);
        System.out.println("Skipped (already existed or invalid): " + skipped);
    }

    private String cleanDescription(String raw) {
        if (raw == null) return null;
        return raw.trim().replaceAll("[,\\s]+$", "");
    }
}
